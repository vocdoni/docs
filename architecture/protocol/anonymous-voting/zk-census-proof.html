<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ZK Census Proof | Vocdoni</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="A decentralized self sovereign governance platform">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.b4782a24.css" as="style"><link rel="preload" href="/assets/js/app.003a3fab.js" as="script"><link rel="preload" href="/assets/js/2.d75a9e61.js" as="script"><link rel="preload" href="/assets/js/26.00dda6a7.js" as="script"><link rel="prefetch" href="/assets/js/10.7d736aa9.js"><link rel="prefetch" href="/assets/js/11.24f4b6a1.js"><link rel="prefetch" href="/assets/js/12.fbc7926a.js"><link rel="prefetch" href="/assets/js/13.1d48d867.js"><link rel="prefetch" href="/assets/js/14.f1695afd.js"><link rel="prefetch" href="/assets/js/15.fd5bd6ca.js"><link rel="prefetch" href="/assets/js/16.7848fcf4.js"><link rel="prefetch" href="/assets/js/17.a09d0fce.js"><link rel="prefetch" href="/assets/js/18.2d6d7bd0.js"><link rel="prefetch" href="/assets/js/19.7ca86ba4.js"><link rel="prefetch" href="/assets/js/20.7610a2ee.js"><link rel="prefetch" href="/assets/js/21.a33e4585.js"><link rel="prefetch" href="/assets/js/22.cdbbe0cb.js"><link rel="prefetch" href="/assets/js/23.daf8da8a.js"><link rel="prefetch" href="/assets/js/24.33f4a899.js"><link rel="prefetch" href="/assets/js/25.ca7b1363.js"><link rel="prefetch" href="/assets/js/27.9643f5df.js"><link rel="prefetch" href="/assets/js/28.95fc6467.js"><link rel="prefetch" href="/assets/js/29.6d11f8e1.js"><link rel="prefetch" href="/assets/js/3.87bd6438.js"><link rel="prefetch" href="/assets/js/30.5f4b8604.js"><link rel="prefetch" href="/assets/js/31.57338027.js"><link rel="prefetch" href="/assets/js/32.c6e6f766.js"><link rel="prefetch" href="/assets/js/33.ee83017b.js"><link rel="prefetch" href="/assets/js/34.9adc375a.js"><link rel="prefetch" href="/assets/js/35.5a5f7bb7.js"><link rel="prefetch" href="/assets/js/36.e2545582.js"><link rel="prefetch" href="/assets/js/37.0eb8cc70.js"><link rel="prefetch" href="/assets/js/38.84124562.js"><link rel="prefetch" href="/assets/js/39.bf4aa161.js"><link rel="prefetch" href="/assets/js/4.6ba5942f.js"><link rel="prefetch" href="/assets/js/40.11b0e7ee.js"><link rel="prefetch" href="/assets/js/41.e727669e.js"><link rel="prefetch" href="/assets/js/42.995b740c.js"><link rel="prefetch" href="/assets/js/43.6a147059.js"><link rel="prefetch" href="/assets/js/44.a2bf17a5.js"><link rel="prefetch" href="/assets/js/45.3ff1d0d1.js"><link rel="prefetch" href="/assets/js/46.c84ab2db.js"><link rel="prefetch" href="/assets/js/47.b5fc1bda.js"><link rel="prefetch" href="/assets/js/48.87932f25.js"><link rel="prefetch" href="/assets/js/49.1b5e3ca0.js"><link rel="prefetch" href="/assets/js/5.0c02ed2b.js"><link rel="prefetch" href="/assets/js/50.0c49f3da.js"><link rel="prefetch" href="/assets/js/51.05425652.js"><link rel="prefetch" href="/assets/js/52.51995a7a.js"><link rel="prefetch" href="/assets/js/53.cd441341.js"><link rel="prefetch" href="/assets/js/54.69d5ba43.js"><link rel="prefetch" href="/assets/js/55.496f36cc.js"><link rel="prefetch" href="/assets/js/56.f98a821f.js"><link rel="prefetch" href="/assets/js/57.bf2fdef7.js"><link rel="prefetch" href="/assets/js/58.f208592f.js"><link rel="prefetch" href="/assets/js/59.a1cf2460.js"><link rel="prefetch" href="/assets/js/6.75834963.js"><link rel="prefetch" href="/assets/js/60.59aefd15.js"><link rel="prefetch" href="/assets/js/7.0929d87c.js"><link rel="prefetch" href="/assets/js/8.66ffbfac.js"><link rel="prefetch" href="/assets/js/9.5e86fdd3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4782a24.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vocdoni</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/architecture/general.html" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="https://blog.vocdoni.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about-us/vision.html" class="nav-link">
  About us
</a></div><div class="nav-item"><a href="https://discord.gg/sQCxgYs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/architecture/general.html" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="https://blog.vocdoni.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about-us/vision.html" class="nav-link">
  About us
</a></div><div class="nav-item"><a href="https://discord.gg/sQCxgYs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/architecture/general" class="sidebar-heading clickable open"><span>Architecture</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/general.html" class="sidebar-link">Global Architecture</a></li><li><a href="/architecture/process-overview.html" class="sidebar-link">Process Overview</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/census/census-overview" class="sidebar-heading clickable"><span>The Census</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/architecture/components.html" class="sidebar-link">Component Overview</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/smart-contracts/entity-resolver" class="sidebar-heading clickable"><span>Smart Contracts</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/services/gateway" class="sidebar-heading clickable"><span>Services</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/data-schemes/entity-metadata" class="sidebar-heading clickable"><span>Data Schemes</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/protocol/json-api" class="sidebar-heading clickable open"><span>Protocol</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/protocol/json-api.html" class="sidebar-link">JSON API</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/architecture/protocol/anonymous-voting/anonymous-voting" class="sidebar-heading clickable open"><span>Anonymous voting</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/protocol/anonymous-voting/zk-census-proof.html" aria-current="page" class="active sidebar-link">ZK Census Proof</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/protocol/anonymous-voting/zk-census-proof.html#protocol-design" class="sidebar-link">Protocol design</a></li><li class="sidebar-sub-header"><a href="/architecture/protocol/anonymous-voting/zk-census-proof.html#implementation-spec" class="sidebar-link">Implementation spec</a></li></ul></li><li><a href="/architecture/protocol/anonymous-voting/blind-signatures.html" class="sidebar-link">Blind Signatures</a></li></ul></section></li><li><a href="/architecture/protocol/rollup.html" class="sidebar-link">Zk-Rollups (proposal)</a></li><li><a href="/architecture/protocol/data-origins.html" class="sidebar-link">Data Origins</a></li></ul></section></li><li><a href="/architecture/component-interaction.html" class="sidebar-link">Component Interaction</a></li><li><a href="/architecture/libraries-tooling.html" class="sidebar-link">Libraries and Tooling</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/integration/overview" class="sidebar-heading clickable"><span>Integration</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/integration/overview.html" class="sidebar-link">Overview</a></li><li><a href="/integration/getting-started-local-vochain.html" class="sidebar-link">Getting started with a local instance</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/integration/vaas-api" class="sidebar-heading clickable"><span>Voting as a Service</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/integration/manual-integration.html" class="sidebar-link">Manual Integration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/integration/census/general" class="sidebar-heading clickable"><span>Census</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/deployment/gateway" class="sidebar-heading clickable"><span>Deployment</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/deployment/gateway.html" class="sidebar-link">Gateway Deployment (stage)</a></li><li><a href="/deployment/miner.html" class="sidebar-link">Miner Deployment</a></li><li><a href="/deployment/oracle.html" class="sidebar-link">Oracle Deployment (stage)</a></li><li><a href="/deployment/custom-vochain.html" class="sidebar-link">Custom Vochain Deployment</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/about-us/vision" class="sidebar-heading clickable"><span>About</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/about-us/vision.html" class="sidebar-link">Vision</a></li><li><a href="/about-us/how-we-work.html" class="sidebar-link">How We Work</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/about-us/development-guidelines" class="sidebar-heading clickable"><span>Development Guidelines</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/about-us/development-guidelines.html" class="sidebar-link">Development guidelines</a></li><li><a href="/about-us/repository-branching.html" class="sidebar-link">Repository and branching guidelines</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="zk-census-proof"><a href="#zk-census-proof" class="header-anchor">#</a> ZK Census Proof</h1> <p>This document is divided in two sections:</p> <ul><li><strong><a href="#protocol-design">Protocol design</a></strong>: high level overview of the protocol.</li> <li><strong><a href="#implementation-spec">Implementation spec</a></strong>: detailed specification, featuring the relevant data structures, hash functions, etc.</li></ul> <h2 id="protocol-design"><a href="#protocol-design" class="header-anchor">#</a> Protocol design</h2> <p>The census proof (also called franchise proof) enables user privacy and allows for fully anonymous voting.</p> <p>The starting point is a <a href="/architecture/census/census-overview.html">Merkle Proof</a>, which efficiently proves that a voter's <em>zkCensusKey</em> belongs to a Merkle Tree (census). However, using this proof alone would allow the organizer of a process to correlate each vote envelope with its voter's the <em>zkCensusKey</em> on the database, so votes wouldn't be secret.</p> <p>To this end, Vocdoni achieves voting anonymity by the use of ZK-Snarks.</p> <h3 id="zksnarks-for-anonymous-voters"><a href="#zksnarks-for-anonymous-voters" class="header-anchor">#</a> zkSNARKs for anonymous voters</h3> <p>Snark stands for <em>Succinct non-interactive argument of knowledge</em>. In our case, this means proving to someone that we know something, but without revealing the contents of what we know.</p> <p>In our case:</p> <ol><li><code>Voter</code> is the owner of the <code>secret key</code> corresponding to a certain <code>zkCensusKey</code></li> <li><code>Voter</code>'s <code>zkCensusKey</code> is included in the <code>census</code> Merkle Tree</li> <li>The nullifier provided by <code>Voter</code> uniquely corresponds to their <code>secret key</code> and the <code>process ID</code> for a specific voting process</li></ol> <p>Although the computation is CPU and memory intensive, ZK Proofs can be generated from the user client running on modest hardware. The proof is validated by the Vochain Nodes, Miners, and any Third Party monitoring the process.</p> <h3 id="zksnark-circuit"><a href="#zksnark-circuit" class="header-anchor">#</a> zkSNARK circuit</h3> <p>Voters use the proving key generated for the circuit below to generate a ZK Proof. The circuit receives both private and public inputs.</p> <p>Data that could reveal the identity of the voter are kept private (gray boxes in the diagram). Public inputs are submitted within the Vote Envelope, so that validators can check them against the proof and make sure that the user hasn't voted twice.</p> <ul><li>The same circuit can be used for any <code>process</code> with a census size of the same range (10k, 100k, 1M, etc).</li> <li>It relies on a <a href="https://medium.com/qed-it/diving-into-the-snarks-setup-phase-b7660242a0d7" target="_blank" rel="noopener noreferrer"><strong>trusted setup ceremony</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div style="padding:20px;background-color:white;"><img src="/zk-census-proof-circuit-diagram.png" alt="Circuit diagram"></div> <p>The circuit above verifies that:</p> <ul><li>the prover is the owner of the secret key</li> <li>the <code>zkCensusKey</code> of the secret key is inside a Hash, which is inside the Merkle Tree with the CensusRoot (<code>key=Poseidon(secretKey), value=0</code>)</li> <li><code>H(secretKey, processID) == nullifier</code></li></ul> <h4 id="proof-generation"><a href="#proof-generation" class="header-anchor">#</a> Proof generation</h4> <p>The franchise proof is generated by running the zkSNARK circuit.</p> <ul><li><strong>Private inputs:</strong> Index, Secret Key, Census Merkle-proof</li> <li><strong>Public inputs:</strong> Census Merkle-root, Nullifier, ProcessId, Vote</li> <li><strong>Output:</strong> Franchise proof</li></ul> <p>Steps:</p> <ol><li><strong>Vote encryption</strong> <ul><li><code>encrypted_vote = encrypt( selected_voting_options + random_nonce )</code></li></ul></li> <li><strong>Nullifier generation</strong> <ul><li><code>nullifier = hash( process_id + user_secret_key )</code></li></ul></li> <li><strong>Fetch merkle proof</strong> <ul><li>From any source that has the census merkle tree such as a Vocdoni Gateway or directly from IPFS.</li></ul></li></ol> <h2 id="implementation-spec"><a href="#implementation-spec" class="header-anchor">#</a> Implementation spec</h2> <h3 id="flow"><a href="#flow" class="header-anchor">#</a> Flow</h3> <p><em>The following flow describes the <em>csv census</em> flow.</em></p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h4 id="steps-description"><a href="#steps-description" class="header-anchor">#</a> Steps description</h4> <div class="custom-block tip"><ul><li><em>[O]</em> = Organizer</li> <li><em>[U]</em> = User</li> <li><em>[V]</em> = Vochain</li> <li><em>[G]</em> = Gateway</li></ul></div> <ol start="0"><li>Circom <a href="https://github.com/vocdoni/zk-franchise-proof-circuit" target="_blank" rel="noopener noreferrer">circuit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is compiled &amp; <strong>Trusted Setup</strong> generated</li> <li><em>[O+V]</em> Create new voting process (newProcessTx) &amp; define the <strong>CensusOrigin</strong> <ul><li>The <strong>CensusOrigin</strong> could be for example:
<ul><li>Using <strong>csv file</strong>: Generate MerkleTree from a <code>csv</code> data file, where the <strong>CensusOrigin</strong> determines the verification of the MerkleProof of that MerkleTree (check <a href="#flow-for-csv-votations">flow-for-csv-votations section</a> for more details)</li> <li>Using <strong>Ethereum storage proofs</strong>: The MerkleTree is the root of the EthereumTree at a certain block, and the <strong>CensusOrigin</strong> determines the verification of the MerkleProof of that Ethereum MerkleTree (check <a href="#flow-for-ethereumstorageproofs-votations">flow-for-ethereumstorageproofs-votations section</a> for more details)</li></ul></li></ul></li> <li><em>[U]</em> Generate CensusRegisterProof, more details:
<ul><li><a href="#flow-for-csv-votations">flow for csv votations</a></li> <li><a href="#flow-for-ethereumstorageproofs-votations">flow for ethereumstorageproofs votations</a></li></ul></li> <li><em>[U]</em> Generate <strong>zkCensusKey</strong> (used as leaf key)
<ul><li>User's <em>zkCensusKey</em>: <code>zkCensusKey = Hash(userSecret)</code></li> <li>This is the key that will be added into the <em>CensusTree</em></li></ul></li> <li><em>[U+V]</em> <strong>Register zkCensusKey</strong> using <strong>CensusRegisterProof</strong> (registerKeyTx)</li></ol> <ul><li>Vochain checks that the <strong>CensusRegistryProof</strong> can be validated for the <strong>CensusOrigin</strong></li></ul> <ol start="5"><li><em>[V]</em> Build voting <strong>census merkle tree</strong> (in state)
<ul><li>Where each leaf contains the hash of each user's <code>secretKey</code> (<em>zkCensusKey</em>)</li> <li>MerkleTree type: circom compatible
<ul><li>Hash function: <a href="https://github.com/iden3/go-iden3-crypto/blob/master/poseidon/poseidon.go" target="_blank" rel="noopener noreferrer">Poseidon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Tree <a href="https://github.com/vocdoni/vocdoni-node/blob/master/censustree/arbotree/wrapper.go" target="_blank" rel="noopener noreferrer">Go impl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></li> <li><em>[V]</em> StartBlock is reached, <strong>process starts</strong></li> <li><em>[V]</em> Last merkle tree root becomes <strong>censusRoot</strong></li> <li><em>[V+U]</em> <strong>Get MerkleProof</strong> <ul><li>Vochain will send the <em>'compressed MerkleProof'</em> (which are the siblings compressed)</li> <li>Client side will need to 'decompress' it
<ul><li>The logic to decompress the siblings <a href="https://github.com/vocdoni/arbo/blob/master/tree.go#L606" target="_blank" rel="noopener noreferrer">can be found here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>And <a href="https://github.com/vocdoni/arbo/blob/master/tree.go#L577" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> the explaination of the encoding</li></ul></li></ul></li> <li><em>[U+G]</em> <strong>Get ProvingKey &amp; WitnessCalc</strong> <ul><li><em>Proving Key &amp; Witness Calc</em> depend on the circuit being used</li></ul></li> <li><em>[U]</em> <strong>Generate zkInputs</strong> <ul><li>check the <a href="#zkInputs-generation">zkInputs generation</a> section for more details</li></ul></li> <li><em>[U]</em> <strong>Generate zkSNARK proof</strong> <ul><li>using: <em>zkInputs + Proving Key + Witness Calculator</em></li></ul></li> <li><em>[U]</em> <strong>Cast the vote</strong> with zkSNARK proof
<ul><li>contains:
<ul><li><em>public inputs</em></li> <li><em>zkProof</em></li> <li><em>vote</em></li></ul></li></ul></li> <li><em>[V]</em> <strong>Verify zkSNARK proof</strong>, accept the vote
<ul><li>Needs to know:
<ul><li>ElectionID</li> <li>Verification Key (depends on the circuit being used (census size))</li> <li>User's <em>public inputs</em> + <em>zkProof</em></li></ul></li></ul></li></ol> <h4 id="flow-for-csv-voting"><a href="#flow-for-csv-voting" class="header-anchor">#</a> Flow for csv voting</h4> <div class="custom-block tip"><p><strong>Important</strong>: This scheme assumes fully trusting the <em>organization</em>, as the
<em>organization</em> could add non-real users to the census that later can be used
to issue valid votes.</p> <p>This use case would set the flag <code>preRegister=true</code> and the <code>CensusOrigin</code> would be <code>OFF_CHAIN_TREE</code> or <code>OFF_CHAIN_TREE_WEIGHTED</code>.</p></div> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><ul><li>0.1. <em>[O]</em> Create user <strong>login keys</strong> <ul><li>from csv data</li></ul></li> <li>0.2. <em>[O]</em> Build <strong>MerkleTree</strong> with login keys</li> <li><ol><li><em>[O+V]</em> Create <strong>new voting process</strong> (newProcessTx) &amp; define the <code>CensusOrigin=OFF_CHAIN_TREE</code></li></ol> <ul><li><strong>CensusOrigin</strong> determines the checks:
<ul><li>the given <em>MerkleProof</em> matches with the defined <em>Census Root</em></li></ul></li></ul></li> <li><ol start="2"><li><em>[U]</em> Generate <strong>CensusRegisterProof</strong></li></ol> <ul><li>which is the MerkleProof that the user 'login key' is in the tree</li></ul></li> <li><ol start="3"><li><em>[U]</em> Generate <strong>zkCensusKey</strong> (used as leaf key)</li></ol> <ul><li>User's <em>zkCensusKey</em>: <code>zkCensusKey = Hash(userSecret)</code> <ul><li>Here <code>userSecret</code> can be <code>csv user's data + secret from user</code></li> <li>This is the key that will be added into the <em>CensusTree</em></li></ul></li></ul></li> <li><ol start="4"><li><em>[U+V]</em> <strong>Register zkCensusKey</strong> using <strong>CensusRegisterProof</strong> (registerKeyTx)</li></ol> <ul><li>Vochain checks that the <strong>CensusRegistryProof</strong> can be validated for the <strong>CensusOrigin</strong></li></ul></li></ul> <div class="custom-block tip"><p>The organization could also directly register <em>Users'</em> secret keys to the Vochain, avoiding the need for a registration phase. This option would use the <code>ProcessMode</code> flags</p> <p>This use case would set the flag <code>preRegister=false</code> and the <code>CensusOrigin</code> would be <code>OFF_CHAIN_TREE</code> or <code>OFF_CHAIN_TREE_WEIGHTED</code> with the <code>CensusRoot</code> determined by the Organization.</p></div> <h4 id="flow-for-ethereumstorageproofs-votations"><a href="#flow-for-ethereumstorageproofs-votations" class="header-anchor">#</a> Flow for EthereumStorageProofs votations</h4> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><ul><li><ol><li><em>[O+V]</em> Create <strong>new voting process</strong> (newProcessTx) &amp; define the <code>CensusOrigin=ERC20</code> (or one of the others available such as <code>ERC777</code>, <code>MINI_ME</code>, etc)</li></ol> <ul><li>CensusOrigin: determines to check that:
<ul><li>the given <em>MerkleProof</em> matches with the defined <em>Ethereum Root</em></li> <li>the sender of the <em>MerkleProof</em> is the owner of that address (check eth-signature)</li></ul></li> <li><em>[O]</em> Define the <em>EthTreeRoot</em> for the <strong>CensusOrigin</strong></li></ul></li> <li><ol start="2"><li><em>[U]</em> Generate <strong>CensusRegisterProof</strong></li></ol> <ul><li>which is the EthereumStorageProof + an ethereum signature by the address of the EthereumStorageProof (to prove ownership of the proof)</li></ul></li> <li><ol start="3"><li><em>[U]</em> Generate <strong>zkCensusKey</strong> (used as leaf key)</li></ol> <ul><li>User's <em>zkCensusKey</em>: <code>zkCensusKey = Hash(userSecret)</code></li> <li>Here <code>userSecret</code> can be the value of the signature of a public known constant made by the user's EthereumKey (where the output is only known by the user, as it is used as a 'secret key'). This is the approach that Hermez zkRollup uses to derive 'snark friendly' keys from Metamask's Ethereum Keys
<ul><li>This is the key that will be added into the <em>CensusTree</em></li></ul></li></ul></li> <li><ol start="4"><li><em>[U+V]</em> <strong>Register zkCensusKey</strong> using <strong>CensusRegisterProof</strong> (registerKeyTx)</li></ol> <ul><li>Vochain checks that the <strong>CensusRegistryProof</strong> can be validated for the <strong>CensusOrigin</strong></li></ul></li></ul> <h3 id="merkle-tree"><a href="#merkle-tree" class="header-anchor">#</a> Merkle Tree</h3> <p>The MerkleTree used for building the <em>anonymous census</em> needs to be a zkSNARK-friendly implementation. As currently we are using <a href="https://github.com/iden3/circom" target="_blank" rel="noopener noreferrer">Circom<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for the zkSNARK circuits, we need to be compatible with the <a href="https://github.com/iden3/circomlib/tree/master/circuits/smt" target="_blank" rel="noopener noreferrer">circomlib<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> MerkleTree implementation. A specification of the MerkleTree <a href="https://docs.iden3.io/publications/pdfs/Merkle-Tree.pdf" target="_blank" rel="noopener noreferrer">can be found here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>In the Vochain, we're using the <a href="https://github.com/vocdoni/arbo" target="_blank" rel="noopener noreferrer">arbo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> MerkleTree, which is a Go implementation compatible with the Circom spec.</p> <p>The MerkleTree uses the <a href="https://eprint.iacr.org/2019/458.pdf" target="_blank" rel="noopener noreferrer">Poseidon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> hash, which is a 'snark-friendly' hash function that later on can be proved inside a circuit without requiring too many constraints.</p> <p>The following diagram contains a visual representation of the data structure of the Leaves of the MerkleTree being used in the scheme of the zk-census-proof.</p> <div style="padding:20px;background-color:white;"><img src="/zk-census-proof-poseidon-merkletree-diagram.png" alt="Poseidon merkle tree with zk census proof"></div> <p>The <code>index</code> value is determined by the <em>CensusTree</em> builder, which has an <code>index</code> value for each <em>CensusTree</em>. This value increments with the addition of each new leaf.</p> <p>The <em>Leaves</em> are structured in this way in order to use the MerkleTrees more efficiently, allowing more user keys to fit inside a smaller tree and therefore reducing the zk circuit size. This is because the value of any given leaf's <em>key</em> determines that leaf's <em>position</em> on the tree. If the leaf key were determined by the <code>zkCensusKey</code>, rather than an incremental <code>index</code>, each new leaf would have a significant chance of collision before filling all the available leaf spots for a given height. Trees would therefore be less balanced and require larger circuits for the same census size due to inefficient use of tree space. With the incremental index approach, on the other hand, all the leaf spots can be filled without a single collision. This produces much smaller circuits for the same number of users.</p> <h3 id="zkinputs-generation"><a href="#zkinputs-generation" class="header-anchor">#</a> zkInputs generation</h3> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// Example of zkInputs</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;censusRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;51642541620950251760298704744678482162425252475654827255045491135352807540162&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;censusSiblings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;30&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;secretKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6190793965647866647574058687473278714480561351424348391693421151024369116465&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;voteHash&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;100964581237483263846637432502620436451&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;278307331411790712608582894981321409946&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;processId&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;115971795979716226347584900263213958763&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;100167351390541057173626244722405453127&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;nullifier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1938187656076799017313903315498318464349291455761501098436114043715056719301&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Origin of each zkInput parameter:</p> <div class="custom-block tip"><p><em>all the parameters are <code>string</code> or <code>[]string</code> that represent <code>bigInt</code> or <code>[]bigInt</code></em></p></div> <ul><li><em>censusRoot</em>: computed by the <em>CensusAuthority</em> from the <em>Census Tree</em></li> <li><em>censusSiblings</em>: computed by the <em>CensusAuthority</em>, is the <em>Merkle Proof</em> <ul><li>the <em>User</em> retrieves the <em>siblings</em> from the <em>Vochain</em> through the <em>Gateway</em></li> <li>the length of <em>censusSiblings</em> will depend on the <em>zkCircuit</em>:
<ul><li>The design of the <em>MerkleTree</em> used in circomlib provokes different lengths in the siblings returned when generating a <em>MerkleProof</em></li> <li>This is due the design of the <em>MerkleTree</em> defines a tree in which the deep of the tree (from the root to the leafs) will depend on each leaf and its neighbors. More details can be found in the <a href="https://docs.iden3.io/publications/pdfs/Merkle-Tree.pdf" target="_blank" rel="noopener noreferrer"><em>MerkleTree</em> spec<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
<ul><li>In order to input those siblings into the circuit, the <code>nLevels</code> of the circuit is fixed, so the length of <em>siblings</em> needs to be fixed also.</li> <li>So, the len(siblings) will depend on the <em>zkCircuit</em> being used, specifically from the <code>nLevels</code> parameter of the circuit</li> <li>The logic needed to be implemented in the User side can be found <a href="https://github.com/vocdoni/zk-franchise-proof-circuit/blob/feature/go-code-inputs-generation/test/go-inputs-generator/census_test.go#L67" target="_blank" rel="noopener noreferrer">here (go) lines 67-70<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and <a href="https://github.com/vocdoni/zk-franchise-proof-circuit/blob/feature/go-code-inputs-generation/src/franchise.js#L33" target="_blank" rel="noopener noreferrer">here (js) line 23<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:
<ul><li><code>while (siblings.length &lt; this.levels) siblings.push(BigInt(0));</code></li></ul></li></ul></li></ul></li></ul></li> <li><em>index</em>: determined by the Vochain when adding the <em>User</em>'s <em>zkCensusKey</em> into the <em>CensusTree</em></li> <li><em>secretKey</em>: generated by the <em>User</em></li> <li><em>voteHash</em>: hashed value of the <em>User</em> vote, composed by two big integers.
<ul><li>The raw user vote is a variable-length array of values and its values do not need to be checked in the circuit. Furthermore, the values can be encrypted.</li> <li>Since the encoded vote values may not fit into a constant number of circuit inputs, we calculate a summary of the raw user vote using an EVM-friendly hash function: <code>sha256(vote_bytes)</code>.  The output of the sha256 hash is slightly larger than the field used in SNARKS, so we split the hash output (32-bytes) into 2 16-byte arrays, take them as integers (in little-endian), and use them as circuit inputs.
<ul><li><code>sha256</code> hash is used, as if necessary in the future it can be <a href="https://github.com/iden3/circomlib/blob/master/circuits/sha256/sha256.circom" target="_blank" rel="noopener noreferrer">verified inside<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> the circuit. This usage has two characteristics to keep in mind:
<ul><li><code>sha256</code> is twice as expensive as <code>keccak256</code> in terms of gas in EVM, but it is implemented in <code>circom</code>, so it can be checked inside a circuit (keccak256 is also <a href="https://github.com/vocdoni/keccak256-circom" target="_blank" rel="noopener noreferrer">implemented inside a circuit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but it takes too many constraints for the current use case)</li> <li>checking the <code>sha256</code> inside a circom circuit is expensive in terms of number of constraints (in the current version of this spec, this is not checked inside the circuit)</li></ul></li></ul></li> <li>example:<div class="language-go extra-class"><pre class="language-go"><code>h <span class="token operator">:=</span> sha256<span class="token punctuation">.</span><span class="token function">Sum256</span><span class="token punctuation">(</span>voteBytes<span class="token punctuation">)</span> <span class="token comment">// voteBytes can be the votes array converted to bytes, or the encrypted votes</span>
b1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span><span class="token function">swapEndianness</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// swap endianness, as golang big int package works in big-endian, and we use little-endian</span>
b2 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span><span class="token function">swapEndianness</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div>And the json input of the <code>voteHash</code> for the circuit would be: <code>&quot;voteHash&quot;: [b1, b2]</code></li></ul></li> <li><em>processId</em>: the process ID in which the <em>User</em> is participating. As the process ID is a 32 byte array, we use the same method used for the <code>voteHash</code>: the 32 bytes of process ID are splitted by the half, and each one is represented as a big integer (little-endian).
<ul><li>example:</li></ul> <div class="language-go extra-class"><pre class="language-go"><code>  processID0 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span><span class="token function">swapEndianness</span><span class="token punctuation">(</span>processIDBytes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// swap endianness, as golang big int package works in big-endian, and we use little-endian</span>
  processID1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span><span class="token function">swapEndianness</span><span class="token punctuation">(</span>processIDBytes<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><em>nullifier</em>: computed by <em>User</em> <ul><li><code>nullifier = poseidon.Hash(sk, processID[0], processID[1])</code></li></ul></li></ul> <h3 id="circuit-identification"><a href="#circuit-identification" class="header-anchor">#</a> Circuit identification</h3> <p>There will be different circuits of the <code>zk-census-proof</code> depending on the census size, also there could be more use cases with different circuit designs.
Both the client and the Vochain need a way to univocally identify those circuits, in order to user the proper <code>Proving key</code>, <code>Witness calculator</code> and <code>Verification key</code> for each circuit.</p> <p>Circuits are identified across the stack by using a Protobuf enum type. Each <code>ProofZkSNARK</code> protobuf package will have a <code>Type</code> identifier indicating which circuit the proof belongs to, so the Vochain knows which <code>Verification Key</code> to use for verifying the proof.</p> <p>Format: <code>CIRCUITNAME_PARAMETER1_PARAMETER2</code></p> <p>List of current types:</p> <ul><li><code>ZKCENSUSPROOF_NLEVELS</code> <ul><li>Circuit name: <a href="https://github.com/vocdoni/zk-franchise-proof-circuit/blob/master/circuits/census.circom" target="_blank" rel="noopener noreferrer"><code>ZKCENSUSPROOF</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Parameters: <code>nLevels</code></li> <li>Example:
<ul><li><code>ZKCENSUSPROOF_100</code></li> <li><code>ZKCENSUSPROOF_1000</code></li></ul></li></ul></li></ul> <h1 id="annex"><a href="#annex" class="header-anchor">#</a> Annex</h1> <h4 id="examples-of-flags-combinations"><a href="#examples-of-flags-combinations" class="header-anchor">#</a> Examples of flags combinations</h4> <p>Below there are listed some common combinations of flags used when created a new process:</p> <ul><li>Census MerkleTree (from CSV file or private database) with pre-register: <code>preRegister=true</code>, <code>CensusOrigin=OFF_CHAIN_TREE</code></li> <li>Census MerkleTree (from CSV file or private database) with the Organization defining the <code>CensusRoot</code> (creating the user's keys, without pre-register phase): <code>preRegister=false</code>, <code>CensusOrigin=OFF_CHAIN_TREE</code></li> <li>Ethereum Storage Proofs with an ERC20 token: <code>preRegister=false</code>, <code>CensusOrigin=ERC20</code></li></ul> <h4 id="keykeepers-reveal-and-commit-keys"><a href="#keykeepers-reveal-and-commit-keys" class="header-anchor">#</a> KeyKeepers reveal and commit keys</h4> <p>A set of commitment keys are generated for each election process by a set of trusted identities named <code>keykeepers</code>. Only if all <code>keykeepers</code> are malicious could they tamper with the process, so it is crucial to distribute these special identities well. Once all these keys are revealed, anyone can generate a valid proof. This mechanism is added to the circuit in order to avoid vote buying when the process is over. Since anyone can now generate a valid proof, a voter will no longer be able to prove that they are the owner of a specific vote nullifier.</p> <div style="padding:20px;background-color:white;"><img src="/zk-census-proof-circuit-with-keykeepers-keys-diagram.png" alt="Circuit with keykeepers diagram"></div> <p>zkInputs of this alternative scheme:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// Example of zkInputs</span>
<span class="token punctuation">{</span>
	<span class="token property">&quot;censusRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;51642541620950251760298704744678482162425252475654827255045491135352807540162&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;censusSiblings&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;secretKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6190793965647866647574058687473278714480561351424348391693421151024369116465&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;voteHash&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;100964581237483263846637432502620436451&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;278307331411790712608582894981321409946&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;processId&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;242108076058607163538102198631955675649&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;142667662805314151155817304537028292174&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;nullifier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1938187656076799017313903315498318464349291455761501098436114043715056719301&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;relayerPublicKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;100&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;relayerProof&quot;</span><span class="token operator">:</span> <span class="token string">&quot;21349690342514405503176665977362532634490340702670001813783738965751319356478&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;revealKey&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">&quot;commitKey&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;19014214495641488759237505126948346942972912379615652741039992445865937985820&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><em>relayerPublicKey</em>: given by the <em>KeyKeeper</em></li> <li><em>relayerProof</em>: computed by the <em>User</em> <ul><li><code>relayerProof = poseidon.Hash(nullifier, relayerPublicKey)</code></li></ul></li> <li><em>revealKey</em>: not known by the user at the proof generation moment
<ul><li>the length of this array is determined by the <code>nMiners</code> parameter of the circuit</li></ul></li> <li><em>commitKey</em>: given by the <em>KeyKeeper</em> <ul><li>the length of this array is determined by the <code>nMiners</code> parameter of the circuit</li> <li><code>poseidon.Hash(relayerPublicKey)</code></li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/31/2022, 10:39:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/architecture/protocol/json-api.html" class="prev">
        JSON API
      </a></span> <span class="next"><a href="/architecture/protocol/anonymous-voting/blind-signatures.html">
        Blind Signatures
      </a>
      
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.003a3fab.js" defer></script><script src="/assets/js/2.d75a9e61.js" defer></script><script src="/assets/js/26.00dda6a7.js" defer></script>
  </body>
</html>

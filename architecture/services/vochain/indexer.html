<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Indexer | Vocdoni</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="A decentralized self sovereign governance platform">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.b4782a24.css" as="style"><link rel="preload" href="/assets/js/app.003a3fab.js" as="script"><link rel="preload" href="/assets/js/2.d75a9e61.js" as="script"><link rel="preload" href="/assets/js/35.5a5f7bb7.js" as="script"><link rel="prefetch" href="/assets/js/10.7d736aa9.js"><link rel="prefetch" href="/assets/js/11.24f4b6a1.js"><link rel="prefetch" href="/assets/js/12.fbc7926a.js"><link rel="prefetch" href="/assets/js/13.1d48d867.js"><link rel="prefetch" href="/assets/js/14.f1695afd.js"><link rel="prefetch" href="/assets/js/15.fd5bd6ca.js"><link rel="prefetch" href="/assets/js/16.7848fcf4.js"><link rel="prefetch" href="/assets/js/17.a09d0fce.js"><link rel="prefetch" href="/assets/js/18.2d6d7bd0.js"><link rel="prefetch" href="/assets/js/19.7ca86ba4.js"><link rel="prefetch" href="/assets/js/20.7610a2ee.js"><link rel="prefetch" href="/assets/js/21.a33e4585.js"><link rel="prefetch" href="/assets/js/22.cdbbe0cb.js"><link rel="prefetch" href="/assets/js/23.daf8da8a.js"><link rel="prefetch" href="/assets/js/24.33f4a899.js"><link rel="prefetch" href="/assets/js/25.ca7b1363.js"><link rel="prefetch" href="/assets/js/26.00dda6a7.js"><link rel="prefetch" href="/assets/js/27.9643f5df.js"><link rel="prefetch" href="/assets/js/28.95fc6467.js"><link rel="prefetch" href="/assets/js/29.6d11f8e1.js"><link rel="prefetch" href="/assets/js/3.87bd6438.js"><link rel="prefetch" href="/assets/js/30.5f4b8604.js"><link rel="prefetch" href="/assets/js/31.57338027.js"><link rel="prefetch" href="/assets/js/32.c6e6f766.js"><link rel="prefetch" href="/assets/js/33.ee83017b.js"><link rel="prefetch" href="/assets/js/34.9adc375a.js"><link rel="prefetch" href="/assets/js/36.e2545582.js"><link rel="prefetch" href="/assets/js/37.0eb8cc70.js"><link rel="prefetch" href="/assets/js/38.84124562.js"><link rel="prefetch" href="/assets/js/39.bf4aa161.js"><link rel="prefetch" href="/assets/js/4.6ba5942f.js"><link rel="prefetch" href="/assets/js/40.11b0e7ee.js"><link rel="prefetch" href="/assets/js/41.e727669e.js"><link rel="prefetch" href="/assets/js/42.995b740c.js"><link rel="prefetch" href="/assets/js/43.6a147059.js"><link rel="prefetch" href="/assets/js/44.a2bf17a5.js"><link rel="prefetch" href="/assets/js/45.3ff1d0d1.js"><link rel="prefetch" href="/assets/js/46.c84ab2db.js"><link rel="prefetch" href="/assets/js/47.b5fc1bda.js"><link rel="prefetch" href="/assets/js/48.87932f25.js"><link rel="prefetch" href="/assets/js/49.1b5e3ca0.js"><link rel="prefetch" href="/assets/js/5.0c02ed2b.js"><link rel="prefetch" href="/assets/js/50.0c49f3da.js"><link rel="prefetch" href="/assets/js/51.05425652.js"><link rel="prefetch" href="/assets/js/52.51995a7a.js"><link rel="prefetch" href="/assets/js/53.cd441341.js"><link rel="prefetch" href="/assets/js/54.69d5ba43.js"><link rel="prefetch" href="/assets/js/55.496f36cc.js"><link rel="prefetch" href="/assets/js/56.f98a821f.js"><link rel="prefetch" href="/assets/js/57.bf2fdef7.js"><link rel="prefetch" href="/assets/js/58.f208592f.js"><link rel="prefetch" href="/assets/js/59.a1cf2460.js"><link rel="prefetch" href="/assets/js/6.75834963.js"><link rel="prefetch" href="/assets/js/60.59aefd15.js"><link rel="prefetch" href="/assets/js/7.0929d87c.js"><link rel="prefetch" href="/assets/js/8.66ffbfac.js"><link rel="prefetch" href="/assets/js/9.5e86fdd3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4782a24.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Vocdoni</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/architecture/general.html" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="https://blog.vocdoni.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about-us/vision.html" class="nav-link">
  About us
</a></div><div class="nav-item"><a href="https://discord.gg/sQCxgYs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/architecture/general.html" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="https://blog.vocdoni.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about-us/vision.html" class="nav-link">
  About us
</a></div><div class="nav-item"><a href="https://discord.gg/sQCxgYs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/architecture/general" class="sidebar-heading clickable open"><span>Architecture</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/general.html" class="sidebar-link">Global Architecture</a></li><li><a href="/architecture/process-overview.html" class="sidebar-link">Process Overview</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/census/census-overview" class="sidebar-heading clickable"><span>The Census</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/architecture/components.html" class="sidebar-link">Component Overview</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/smart-contracts/entity-resolver" class="sidebar-heading clickable"><span>Smart Contracts</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/services/gateway" class="sidebar-heading clickable open"><span>Services</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/services/gateway.html" class="sidebar-link">Gateway</a></li><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/architecture/services/vochain" class="sidebar-heading clickable router-link-active open"><span>Vochain</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/architecture/services/vochain.html" class="sidebar-link">Vochain</a></li><li><a href="/architecture/services/vochain/indexer.html" aria-current="page" class="active sidebar-link">Indexer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/architecture/services/vochain/indexer.html#overall" class="sidebar-link">Overall</a></li><li class="sidebar-sub-header"><a href="/architecture/services/vochain/indexer.html#core-components" class="sidebar-link">Core components</a></li><li class="sidebar-sub-header"><a href="/architecture/services/vochain/indexer.html#how-it-works" class="sidebar-link">How it works</a></li></ul></li><li><a href="/architecture/services/vochain/evm-less-vochain.html" class="sidebar-link">EVM-less Vochain</a></li></ul></section></li><li><a href="/architecture/services/census-service.html" class="sidebar-link">Census Service</a></li><li><a href="/architecture/services/bootnode.html" class="sidebar-link">Boot node</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/data-schemes/entity-metadata" class="sidebar-heading clickable"><span>Data Schemes</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/architecture/protocol/json-api" class="sidebar-heading clickable"><span>Protocol</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/architecture/component-interaction.html" class="sidebar-link">Component Interaction</a></li><li><a href="/architecture/libraries-tooling.html" class="sidebar-link">Libraries and Tooling</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/integration/overview" class="sidebar-heading clickable"><span>Integration</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/integration/overview.html" class="sidebar-link">Overview</a></li><li><a href="/integration/getting-started-local-vochain.html" class="sidebar-link">Getting started with a local instance</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/integration/vaas-api" class="sidebar-heading clickable"><span>Voting as a Service</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/integration/manual-integration.html" class="sidebar-link">Manual Integration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/integration/census/general" class="sidebar-heading clickable"><span>Census</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/deployment/gateway" class="sidebar-heading clickable"><span>Deployment</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/deployment/gateway.html" class="sidebar-link">Gateway Deployment (stage)</a></li><li><a href="/deployment/miner.html" class="sidebar-link">Miner Deployment</a></li><li><a href="/deployment/oracle.html" class="sidebar-link">Oracle Deployment (stage)</a></li><li><a href="/deployment/custom-vochain.html" class="sidebar-link">Custom Vochain Deployment</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/about-us/vision" class="sidebar-heading clickable"><span>About</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/about-us/vision.html" class="sidebar-link">Vision</a></li><li><a href="/about-us/how-we-work.html" class="sidebar-link">How We Work</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/about-us/development-guidelines" class="sidebar-heading clickable"><span>Development Guidelines</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/about-us/development-guidelines.html" class="sidebar-link">Development guidelines</a></li><li><a href="/about-us/repository-branching.html" class="sidebar-link">Repository and branching guidelines</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="indexer"><a href="#indexer" class="header-anchor">#</a> Indexer</h1> <h2 id="overall"><a href="#overall" class="header-anchor">#</a> Overall</h2> <p>The indexer is the component that tallies and decode/decrypt (if needed) each vote stored in the voting blockchain for each process of each entity.</p> <p>The way the indexer works is defined by the process vote type and the process mode eligible configurations.</p> <p>The <strong>internal indexer database</strong> is used for storing the results, processes, references to votes and transactions, and information about the number of items in the Vochain state. Storing data linked to the Vochain state changes adds safety and data correctness in front of numerous failures and provides much more powerful access to querying the Vochain.</p> <h2 id="core-components"><a href="#core-components" class="header-anchor">#</a> Core components</h2> <p>The indexer needs to be attached to a full <strong>Vochain node</strong> in order to access the latest state accurately. The state is for retrieving votes, processes, transactions, and other useful info for computing the results for each process.</p> <p>It also maintains six pools and an internal database for data persistence:</p> <h3 id="vote-pool"><a href="#vote-pool" class="header-anchor">#</a> Vote pool</h3> <p>Used for computing processes with real-time results. Votes are added to the results storage for the given process ID.</p> <p>Each pool item contains a single vote with the following fields:</p> <ul><li>Height</li> <li>Nullifier</li> <li>Process ID</li> <li>Vote package</li> <li>Encryption key indexes</li> <li>Weight</li></ul> <h3 id="vote-index-pool"><a href="#vote-index-pool" class="header-anchor">#</a> Vote Index pool</h3> <p>Used for storing all votes along with their transaction indexes, including those without live results. A reference to the vote's transaction is stored in the indexer database/</p> <p>Each pool item contains a single vote &amp; index with the following fields:</p> <ul><li>Vote
<ul><li>Height</li> <li>Nullifier</li> <li>Process ID</li> <li>Vote package</li> <li>Encryption key indexes</li> <li>Weight</li></ul></li> <li>TxIndex</li></ul> <h3 id="new-process-pool"><a href="#new-process-pool" class="header-anchor">#</a> New Process pool</h3> <p>Used for initially storing processes to the indexer database.</p> <p>Each pool item contains a single process with the following fields:</p> <ul><li>Process Id</li> <li>Entity Id (Organization identifier)</li></ul> <h3 id="update-process-pool"><a href="#update-process-pool" class="header-anchor">#</a> Update Process pool</h3> <p>Used for signifying which processes may need to be updated in the indexer database. Each process in the pool is updated according to the current Vochain state, and final results are computed if applicable.</p> <p>Live processes results are computed in parallel for every new Vochain block and the results of encrypted or non live processes are scheduled for the tally when the end block of a process is reached or when the keys of a processes are published.</p> <p>Each pool item contains a byte array representing the identifier for a process which needs to be updated.</p> <h3 id="new-tx-pool"><a href="#new-tx-pool" class="header-anchor">#</a> New Tx pool</h3> <p>Used for storing a reference to each new transaction on the Vochain and updating the total count of transactions. Transaction references can then be used to easily access transactions directly from the Vochain state.</p> <p>Each pool item contains a single transaction reference with the following fields:</p> <ul><li>Index <em>(the transaction's height on the Vochain)</em></li> <li>BlockIndex <em>(The index of the block containing the transaction)</em></li> <li>TxBlockIndex <em>(The transaction's index on the block containing it)</em></li></ul> <h3 id="results-pool"><a href="#results-pool" class="header-anchor">#</a> Results pool</h3> <p>The results pool is used to signal which processes need to have results computed and finalized when either:</p> <ul><li>The end block is reached</li> <li>The encryption keys are revealed</li> <li>The results need to be computed in real time</li></ul> <p>Each pool item contains a single process with the following fields:</p> <ul><li>Process Id</li> <li>Entity Id (Organization identifier)</li></ul> <div style="padding:5px;background-color:white;"><img src="/indexer-comp.svg" alt="indexer components"></div> <h2 id="how-it-works"><a href="#how-it-works" class="header-anchor">#</a> How it works</h2> <p>The indexer is very tied to the Vochain, this is because its functionality relies on state changes on the Vochain application state.</p> <p>There are some functions that change the Vochain state that are associated to one or more <strong>callback functions</strong> and can be used for other processes in order to do some side logic. One of the components using this feature is the indexer.</p> <h3 id="commit"><a href="#commit" class="header-anchor">#</a> Commit</h3> <p>When the <code>Commit</code> function is called on the Vochain,  a signal is triggered in order to inform the indexer that the latest changes are finalized and persistent.</p> <p>In the commit stage all the pools are iterated in order compute the results of each process that is meant to be tallied. As said, there are different situations in which the indexer must compute the results of a process:</p> <ul><li>The process keys are revealed.</li> <li>The process end block is reached.</li> <li>The process is real time (in this case, the votes on the vote pool are fetched in order to be computed live at the given Vochain height).</li></ul> <h3 id="rollback"><a href="#rollback" class="header-anchor">#</a> Rollback</h3> <p>If the <code>Rollback</code> function is called on the Vochain, the current non persisted changes will be discarded.</p> <h3 id="onprocess"><a href="#onprocess" class="header-anchor">#</a> OnProcess</h3> <p>When a new process is created, it is added to the New Process pool to be stored on the indexer database.</p> <h3 id="onvote"><a href="#onvote" class="header-anchor">#</a> OnVote</h3> <p>When a new vote is registered, it is added to the Vote Index pool so the vote transaction can be referenced from the indexer. If the vote belongs to a process with live results, it is also added to the Vote pool so that the results stored by the indexer can count the new vote.</p> <h3 id="oncancel"><a href="#oncancel" class="header-anchor">#</a> OnCancel</h3> <p>When a process is cancelled, its ID is added to the Update Process pool.</p> <h3 id="onprocesskeys"><a href="#onprocesskeys" class="header-anchor">#</a> OnProcessKeys</h3> <p>When a process' keys are added, its ID is added to the Update Process pool.</p> <h3 id="onprocessstatuschange"><a href="#onprocessstatuschange" class="header-anchor">#</a> OnProcessStatusChange</h3> <p>When a process' status is changed, its ID is added to the Update Process pool. If the process changes to the <code>ended</code> status and its votes are not encrypted, it is also added to the Results pool to compute final results.</p> <h3 id="onrevealkeys"><a href="#onrevealkeys" class="header-anchor">#</a> OnRevealKeys</h3> <p>When a process' keys are revealed, its ID is added to the Update Process pool. It is also added to the Results pool to decrypt the votes and compute final results.</p> <h3 id="onprocessresults"><a href="#onprocessresults" class="header-anchor">#</a> OnProcessResults</h3> <p>When the Vochain signals that a process' results are available, the results are checked for validity and then the process ID is added to the Update Process pool.</p> <div style="padding:20px;background-color:white;"><img src="/indexer-flow.svg" alt="indexer work flow"></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/6/2021, 9:37:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/architecture/services/vochain.html" class="prev">
        Vochain
      </a></span> <span class="next"><a href="/architecture/services/vochain/evm-less-vochain.html">
        EVM-less Vochain
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.003a3fab.js" defer></script><script src="/assets/js/2.d75a9e61.js" defer></script><script src="/assets/js/35.5a5f7bb7.js" defer></script>
  </body>
</html>

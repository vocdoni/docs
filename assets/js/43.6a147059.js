(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{408:function(e,a,t){"use strict";t.r(a);var s=t(24),o=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"gateway-deployment-stage"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gateway-deployment-stage"}},[e._v("#")]),e._v(" Gateway Deployment (stage)")]),e._v(" "),t("p",[e._v("This section shows how to deploy a node with the gateway role running on Vocdoni, which provides an entry point to the P2P networks for the clients. To get more information about the gateway component, read the "),t("a",{attrs:{href:"https://docs.vocdoni.io/#/architecture/services/gateway",target:"_blank",rel:"noopener noreferrer"}},[e._v("gateway docs"),t("OutboundLink")],1),e._v(".")]),e._v(" "),t("h2",{attrs:{id:"requirements"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#requirements"}},[e._v("#")]),e._v(" Requirements")]),e._v(" "),t("h3",{attrs:{id:"hardware"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hardware"}},[e._v("#")]),e._v(" Hardware")]),e._v(" "),t("ul",[t("li",[e._v("2 Cores")]),e._v(" "),t("li",[e._v("8GB RAM")]),e._v(" "),t("li",[e._v("40GB SSD disk space")])]),e._v(" "),t("h3",{attrs:{id:"software"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#software"}},[e._v("#")]),e._v(" Software")]),e._v(" "),t("ul",[t("li",[e._v("GNU/Linux based operating system")]),e._v(" "),t("li",[e._v("Git")]),e._v(" "),t("li",[e._v("Docker engine (version 19.03 or above) "),t("a",{attrs:{href:"https://docs.docker.com/engine/install/#server",target:"_blank",rel:"noopener noreferrer"}},[e._v("Installation"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("Docker compose (version 1.24 or above) "),t("a",{attrs:{href:"https://docs.docker.com/compose/install",target:"_blank",rel:"noopener noreferrer"}},[e._v("Installation"),t("OutboundLink")],1)])]),e._v(" "),t("h3",{attrs:{id:"network"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#network"}},[e._v("#")]),e._v(" Network")]),e._v(" "),t("p",[e._v("The list of exposed ports to the Internet is as follows:")]),e._v(" "),t("ul",[t("li",[e._v("443")]),e._v(" "),t("li",[e._v("4001")]),e._v(" "),t("li",[e._v("4171")]),e._v(" "),t("li",[e._v("9090")]),e._v(" "),t("li",[e._v("26656")]),e._v(" "),t("li",[e._v("26657")])]),e._v(" "),t("p",[e._v("Note: All all ports are TCP.")]),e._v(" "),t("p",[e._v("It is also required for the API to have a public DNS domain available and with A / AAAA records pointing to the gateway IP.")]),e._v(" "),t("h3",{attrs:{id:"docker-compose"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose"}},[e._v("#")]),e._v(" Docker compose")]),e._v(" "),t("p",[e._v("Hands on! Clone the repository "),t("a",{attrs:{href:"https://github.com/vocdoni/vocdoni-node",target:"_blank",rel:"noopener noreferrer"}},[e._v("vocdoni-node"),t("OutboundLink")],1),e._v(" in your current path, and change the branch:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" clone https://github.com/vocdoni/vocdoni-node\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" vocdoni-node\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" checkout stage\n")])])]),t("p",[e._v("This is the source path of the vocdoni-node. We are going to use files provided for a docker compose deploy:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" dockerfiles/dvotenode\n"),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("ls")]),e._v("\n")])])]),t("p",[e._v("As you can see, there are many YAML files. The main one we are going to use is "),t("code",[e._v("docker-compose.yml")]),e._v(". This file uses the "),t("code",[e._v("env")]),e._v(" file to configure the node with environment variables. There are many parameters to configure, but we are going to show a basic selection of them just to get started with the mainnet. To get a reference of all the variables, check the "),t("code",[e._v("env.example")]),e._v(" file.")]),e._v(" "),t("p",[e._v("Now, create and edit the "),t("code",[e._v("env")]),e._v(" file and add the content like this:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_DATADIR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/app/run\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_MODE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("gateway\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_IPFS_SYNCKEY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("vocdonistage\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_API_SSL_DOMAIN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_ETHCONFIG_SIGNINGKEY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_VOCHAINCONFIG_MEMPOOLSIZE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("200000")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_W3CONFIG_ENABLED")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("False\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_ETHCONFIG_NOWAITSYNC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("True\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_METRICS_ENABLED")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("True\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_METRICS_REFRESHINTERVAL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_VOCHAIN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("stage\n")])])]),t("p",[e._v("Now, we are going to generate a random number of 32bits and we will use as a private key, and to have a fixed public address derived from it. Run the following command (only once) to add the key to the env file.")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[e._v("sed")]),e._v(" -i "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"s/DVOTE_ETHCONFIG_SIGNINGKEY=/&'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("openssl rand -hex "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("32")]),t("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v('/"')]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("env")]),e._v("\n")])])]),t("p",[e._v("It is highly recommended to add SSL support to your gateways APIs. You can add your own using other components in your Docker stack, such as "),t("code",[e._v("nginx-proxy")]),e._v(" or "),t("code",[e._v("traefik")]),e._v(". However, go-dvote has full Let's Encrypt support built in.")]),e._v(" "),t("p",[e._v("To get the certificates and enable it, we are going to assume you have a DNS domain pointing to your gateway, i.e. "),t("code",[e._v("gateway1.mydomain.net")]),e._v(". If that's ready, then it's only a matter of adding a new variable to the "),t("code",[e._v("env")]),e._v(" file, using your own domain:")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("DVOTE_API_SSL_DOMAIN")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("gateway1.mydomain.net\n")])])]),t("p",[e._v("Now we are ready to start the node. First, let's pull the docker image:")]),e._v(" "),t("p",[t("code",[e._v("docker-compose -f docker-compose.watchtower.yml -f docker-compose.yml pull")])]),e._v(" "),t("p",[e._v("Then we start the node in a detached mode:")]),e._v(" "),t("p",[t("code",[e._v("docker-compose -f docker-compose.watchtower.yml -f docker-compose.yml up -d")])]),e._v(" "),t("p",[e._v("The gateway should be up and syncing the vochain with other peers.")]),e._v(" "),t("p",[e._v("To get some output from the logs run this command")]),e._v(" "),t("p",[t("code",[e._v('docker-compose logs | grep "custom pubKey"')])]),e._v(" "),t("p",[e._v("You should see a line similar to this:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("dvotenode_1  | 2020-10-19T14:01:20Z\tINFO\tdvotenode/dvotenode.go:403\tusing custom pubKey 020ea27524f0daa120d9f04a1aaebb82944137e4eb675f0510c216c299a9412ab4\n")])])]),t("p",[e._v("This is the public key that identifies your gateway node, and will be used to add your node to the list of public gateways of Vocdoni. "),t("strong",[e._v("This is the value you have to share with other participants.")])]),e._v(" "),t("p",[e._v("Now the node is syncing, you can track the progress with:")]),e._v(" "),t("p",[t("code",[e._v("docker-compose logs -f")])]),e._v(" "),t("p",[e._v("There are lines like the following:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("dvotenode_1  | 2020-10-20T07:21:39Z\tINFO\tservice/vochain.go:133\t[vochain info] fastsync running at block 6392 (52 blocks/s), peers 10\n")])])]),t("p",[t("strong",[e._v("Warning:")]),e._v(" Do not share the private key with other gateways of the network, and save a backup as it could be needed in case of data loss.")])])}),[],!1,null,null,null);a.default=o.exports}}]);